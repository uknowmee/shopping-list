@page "/ShoppingLists/AddItems"
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Shopping.List.App.Blazor.Database.Auth
@using Shopping.List.App.Blazor.Database.ShoppingList

@rendermode InteractiveServer

@inject NavigationManager NavigationManager
@inject UserManager<ApplicationUser> UserManager
@inject ILogger<AddItems> Logger
@inject ShoppingListCtx Ctx

<PageTitle>AddItems</PageTitle>

<h3>Add Items</h3>

<div class="controlNav">
    <div>
        <button class="btn btn-primary" @onclick="BackToLists">Back</button>
    </div>
    <div>
        <button class="btn btn-primary" @onclick="AddNewItem">New</button>
    </div>
</div>

@if (List?.Items != null)
{
    <div class="items-container">
        @foreach (var item in List.Items)
        {
            <div class="item-card">
                <Card>
                    <BodyTemplate>
                        <div class="img">
                            <img src="@(item.Picture?.PicturePath ?? "https://www.pngkey.com/png/detail/233-2332677_image-500580-placeholder-transparent.png")" alt="Item Picture" width="100" height="100"/>
                        </div>
                        <div>
                            <label>Category:</label>
                            <Select TValue="string" Color="Color.Primary" Items="UserCategories" IsEditable="true" Value="item.Category" OnValueChanged="@(val => CategoryChanged(val, item))"></Select>
                        </div>
                        <div>
                            <label>Size:</label>
                            <Select TValue="string" Color="Color.Primary" Items="UserSizes" IsEditable="true" Value="item.Size" OnValueChanged="@(val => SizeChanged(val, item))"></Select>
                        </div>
                        <div>
                            <label>Picture:</label>
                            <Select TValue="ItemPicture" Color="Color.Primary" Items="UserPictures" IsEditable="false" Value="item.Picture" OnValueChanged="@(val => PictureChanged(val, item))"></Select>
                        </div>
                        <div class="itm-bottom">
                            <div class="delete">
                                <button class="btn btn-danger" @onclick="() => DeleteItem(item)">Delete</button>
                            </div>
                            <div class="quantity">
                                <label>Quantity:</label>
                                <BootstrapInputNumber TValue="int" Min="1" Value="@item.Quantity" IsSelectAllTextOnFocus="true" OnValueChanged="@(val => QuantityChanged(val, item))"/>
                            </div>
                        </div>
                    </BodyTemplate>
                </Card>
            </div>
        }
    </div>
}

@code {
    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    [SupplyParameterFromQuery(Name = "Id")]
    private Guid? ListId { get; set; }

    private const string HomeUri = "/ShoppingLists/Home";
    private ShoppingUser? _user;
    private ItemList? List => _user?.Lists.SingleOrDefault(l => l.Id == ListId);

    private IEnumerable<SelectedItem<ItemPicture>> UserPictures
        => _user is not null
            ? _user.Lists
                .SelectMany(l => l.Items)
                .Select(i => i.Picture)
                .Where(p => p is not null)
                .Distinct()
                .Select(p => new SelectedItem<ItemPicture> { Value = p, Text = p?.PictureName ?? "" })
                .Append(new SelectedItem<ItemPicture> { Value = null, Text = "No Picture" })
                .ToList()
            : [];

    private IEnumerable<SelectedItem> UserCategories
        => _user is not null
            ? _user.Lists
                .SelectMany(l => l.Items)
                .Select(i => i.Category)
                .Distinct()
                .Select(c => new SelectedItem { Value = c, Text = c })
                .ToList()
            : [];

    private IEnumerable<SelectedItem> UserSizes
        => _user is not null
            ? _user.Lists
                .SelectMany(l => l.Items)
                .Select(i => i.Size)
                .Distinct()
                .Select(s => new SelectedItem { Value = s, Text = s })
                .ToList()
            : [];

    protected override async Task OnInitializedAsync()
    {
        if (ListId is null)
        {
            Logger.LogWarning("List Id not provided");
            BackToLists();
            return;
        }

        var authState = await AuthenticationStateTask;
        var user = await UserManager.GetUserAsync(authState.User) ?? throw new InvalidOperationException("User not found");

        if (await Ctx.Lists
                .AsNoTracking()
                .AnyAsync(l => l.Id == ListId && l.UserId == user.Id) is false)
        {
            Logger.LogWarning("List not found");
            BackToLists();
        }

        _user = await Ctx.Users
            .Include(u => u.Lists)
            .ThenInclude(l => l.Items)
            .ThenInclude(i => i.Picture)
            .SingleAsync(u => u.Id == user.Id);
    }

    private void BackToLists() => NavigationManager.NavigateTo(HomeUri);

    private async Task AddNewItem()
    {
        if (List is null) return;
        var item = List.AddItemAtFront();
        await Ctx.AddAsync(item);
        await Ctx.SaveChangesAsync();
    }

    private async Task DeleteItem(Item item)
    {
        if (List is null) return;
        List.Items.Remove(item);
        Ctx.Remove(item);
        await Ctx.SaveChangesAsync();
    }

    private async Task QuantityChanged(int val, Item item)
    {
        item.Quantity = val;
        await Ctx.SaveChangesAsync();
    }

    private async Task PictureChanged(ItemPicture? val, Item item)
    {
        if (val is null) return;
        item.Picture = val;
        await Ctx.SaveChangesAsync();
        StateHasChanged();
    }

    private async Task CategoryChanged(string? val, Item item)
    {
        if (val is null) return;
        item.Category = val;
        await Ctx.SaveChangesAsync();
        StateHasChanged();
    }

    private async Task SizeChanged(string? val, Item item)
    {
        if (val is null) return;
        item.Size = val;
        await Ctx.SaveChangesAsync();
        StateHasChanged();
    }

}